<script context="module">
	export const ROUTE = { }; 
</script>

<script>
	import { getContext, setContext, onDestroy } from 'svelte';
	import { writable } from 'svelte/store';
	import { ROUTER } from './Router.html';

	const { registerRoute, selectedRoute } = getContext(ROUTER);

	export let path; 
	export let asyncComponent = null;

	const route = { path, asyncComponent, ctx: { } };

	let componentPromise; 
	let target;

	setContext(ROUTE, route);
	
	registerRoute(route);
	selectedRoute.subscribe(selected => {
		if(!selected) return;
		route.ctx = selected.ctx;
		if(asyncComponent && selected && selected.route == route) {
			componentPromise = Promise.all([
				asyncComponent(), 
				// todo: optionally fetch data/props concurrently with component import?
			])
			.then(([{default: Component}, props]) => {
				return new Component({
					target
				});
			})
			.catch(err => {
				console.log('Todo: handle error with generic/specific handler:\n', err)
				throw err;
			}); 
		}
	});


</script>

{#if $selectedRoute && $selectedRoute.route == route}
	{#if asyncComponent}
		{#await componentPromise}
			<slot name="loading">
				<p>Loading... </p>
			</slot>
		{:then}
		{:catch}
			<slot name="error">
				Error!
			</slot>
		{/await}
		<div bind:this={target}></div>
	{:else}
		<slot name="component"></slot>
	{/if}
{/if}