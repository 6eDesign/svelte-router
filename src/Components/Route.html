<script>
	import { getContext, onDestroy } from 'svelte';
	import { writable } from 'svelte/store';
	import { ROUTER } from './Router.html';

	const {
		registerRoute, 
		selectedRoute, 
		ErrorComponent=null 
	} = getContext(ROUTER);

	// props
	export let path; 
	export let asyncComponent = null;
	export let component = null;
	export let middleware = [];
	export let metadata = { }

	// template variables
	let componentPromise; 
	let target;
	let routeError = null;

	const route = { path, asyncComponent, middleware, metadata };

	registerRoute(route);

	selectedRoute.subscribe(selected => {
		if(!selected) return;
		if(asyncComponent && selected && selected.route == route) {
			componentPromise = asyncComponent().then(
				({default: Component}) => {
					return new Component({
						target
					});
			}); 
		}
	});

</script>

<!-- todo: 
			change all slots to vars w/ svelte:component
			or maintain option of using slot or component
			everywhere? 
-->
{#if $selectedRoute && $selectedRoute.route == route}
	{#if asyncComponent}
		{#await componentPromise}
			<slot name="loading">
				<p>Loading... </p>
			</slot>
		{:then}
		{:catch}
			<slot name="error">
				{#if ErrorComponent}
					<svelte:component this={ErrorComponent} />
				{:else}
					<p>Error!</p>
				{/if}
			</slot>
		{/await}
		<div bind:this={target}></div>
	{:elseif component}
		<svelte:component this={component} />
	{:else}
		<slot name="component"></slot>
	{/if}
{/if}