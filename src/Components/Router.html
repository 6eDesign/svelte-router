<script context="module">
	export const ROUTER = { }; 
</script>

<script>
	import { setContext, onMount, afterUpdate } from 'svelte';
	import { writable, derive } from 'svelte/store';
	import page from 'page.js';
	
	let selectedRoute = writable(null);

	export let middleware = [];
	export let hashbang = false;
	export let metadata = { }; 
	export let error = null;
	export let loading = null;

	const applyMetadata = ({ metadata: route }) => (ctx,next) => { 
		ctx.metadata = { 
			route, 
			router: metadata
		};
		next(); 
	};

	const routeMiddleware = route => (ctx) => { 
		selectedRoute.set({ctx, route});
		// todo: will need to call next if there are child routes
	};
	
	setContext(ROUTER, { 
		registerRoute(route) { 
			page(
				route.path, 
				applyMetadata(route),
				...middleware, 
				...route.middleware,
				routeMiddleware(route)
			); 
		}, 
		error,
		loading,
		selectedRoute
	});

	onMount(() => {
		setTimeout(() => {
			page({hashbang}); 
		}, 0);
	});

</script>

<slot></slot>